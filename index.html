<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBME ‚Äì Ch·∫©n ƒëo√°n h·ªôi ch·ª©ng YHCT (T·ª© ch·∫©n)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1730;
      --text:#e8ecff;
      --muted:#b6c0ffb3;
      --line:#26335f;
      --accent:#7aa2ff;
      --accent2:#8bf0c1;
      --danger:#ff6b8a;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% 10%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(139,240,193,.10), transparent 55%),
                  radial-gradient(900px 600px at 50% 100%, rgba(255,107,138,.08), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height:100vh;
      padding: 28px 16px 48px;
    }
    .wrap{max-width:1080px;margin:0 auto;}
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      margin-bottom:18px;
    }
    .title{display:flex;flex-direction:column;gap:6px;}
    h1{margin:0;font-size:22px;letter-spacing:.2px;}
    .subtitle{margin:0;color:var(--muted);font-size:13px;line-height:1.4;max-width:80ch;}
    .tabs{
      display:flex; gap:10px;
      background: rgba(18,26,51,.55);
      border: 1px solid rgba(38,51,95,.65);
      padding: 8px;
      border-radius: 999px;
      box-shadow: var(--shadow);
    }
    .tab-btn{
      appearance:none; border:0; background:transparent;
      color:var(--muted);
      padding:10px 14px; border-radius:999px;
      font-weight:700; font-size:13px;
      cursor:pointer; transition:.2s ease;
      display:flex;align-items:center;gap:8px;
      user-select:none;
    }
    .tab-btn:hover{color:var(--text); background: rgba(122,162,255,.10);}
    .tab-btn[aria-selected="true"]{
      background: linear-gradient(135deg, rgba(122,162,255,.22), rgba(139,240,193,.14));
      color: var(--text);
      border: 1px solid rgba(122,162,255,.25);
    }
    .panel{margin-top:16px; display:none; animation: fadeIn .18s ease-out;}
    .panel.active{display:block;}
    @keyframes fadeIn{from{opacity:.4; transform: translateY(4px);} to{opacity:1; transform: translateY(0);} }

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px;}
    @media (max-width: 980px){
      header{flex-direction:column; align-items:flex-start}
      .tabs{width:100%}
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(18,26,51,.85), rgba(15,23,48,.85));
      border: 1px solid rgba(38,51,95,.75);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      color:var(--text);
      background: rgba(122,162,255,.14);
      border: 1px solid rgba(122,162,255,.22);
    }

    .form{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .form .full{grid-column:1 / -1;}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px;}
    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      background: rgba(8,12,26,.65);
      border: 1px solid rgba(38,51,95,.75);
      color: var(--text);
      outline:none;
      transition:.15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(122,162,255,.6);
      box-shadow: 0 0 0 3px rgba(122,162,255,.14);
    }
    textarea{min-height:120px; resize: vertical; line-height: 1.5;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px;}
    .btn{
      appearance:none;
      border: 1px solid rgba(38,51,95,.85);
      background: rgba(122,162,255,.14);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex;align-items:center;gap:10px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.55);}
    .btn.secondary{background: rgba(182,192,255,.08);}
    .btn.danger{background: rgba(255,107,138,.12); border-color: rgba(255,107,138,.35);}
    .hint{color: var(--muted); font-size:12px; line-height:1.4; margin:6px 0 0;}

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(38,51,95,.75);
      background: rgba(8,12,26,.55);
      color: var(--muted);
      font-size: 12px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .subtabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin: 2px 0 12px;
    }
    .chip{
      border:1px solid rgba(38,51,95,.75);
      background: rgba(8,12,26,.45);
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
    }
    .chip.active{
      color: var(--text);
      background: rgba(122,162,255,.14);
      border-color: rgba(122,162,255,.35);
    }

    .block{display:none;}
    .block.active{display:block;}

    .vancard{
      border: 1px solid rgba(38,51,95,.75);
      background: rgba(8,12,26,.45);
      border-radius: 14px;
      padding: 12px;
    }

    /* V·∫•n ch·∫©n items */
    .sym-toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;}
    .sym-list{display:grid; gap:10px; margin-top:10px;}
    .sym-item{
      border: 1px solid rgba(38,51,95,.75);
      background: rgba(8,12,26,.45);
      border-radius: 14px;
      padding: 12px;
    }
    .sym-head{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start;
      margin-bottom:10px;
    }
    .sym-name{
      font-weight:800; font-size:13px; margin:0;
    }
    .sym-actions{display:flex; gap:8px;}
    .icon-btn{
      appearance:none;
      border: 1px solid rgba(38,51,95,.75);
      background: rgba(182,192,255,.08);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 800;
      cursor:pointer;
    }
    .sym-grid{
      display:grid;
      grid-template-columns: 1.2fr .6fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .sym-grid{grid-template-columns:1fr;}
    }

    /* Output */
    .result-top{display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start; margin-bottom:12px;}
    .diag{
      border-left: 3px solid rgba(139,240,193,.75);
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(139,240,193,.06);
      border: 1px solid rgba(139,240,193,.18);
      margin-top: 10px;
    }
    .diag h3{margin:0 0 6px;font-size:14px;}
    .diag p{margin:0;color:var(--text);line-height:1.55;font-size:13px;}
    .list{margin: 10px 0 0; padding: 0; list-style: none; display:grid; gap:10px;}
    .item{
      border: 1px solid rgba(38,51,95,.75);
      background: rgba(8,12,26,.55);
      border-radius: 14px;
      padding: 12px;
    }
    .item .k{
      font-weight: 900; font-size: 13px;
      margin:0 0 6px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .score{
      font-size: 12px;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(122,162,255,.16);
      border: 1px solid rgba(122,162,255,.28);
      white-space: nowrap;
    }
    .item .v{margin:0; color: var(--muted); font-size: 12px; line-height: 1.45;}
    .warn{
      border-left: 3px solid rgba(255,107,138,.75);
      background: rgba(255,107,138,.06);
      border: 1px solid rgba(255,107,138,.18);
      padding: 10px 12px;
      border-radius: 14px;
      margin-top: 12px;
    }
    .warn b{color: var(--text);}
    footer{margin-top: 16px; color: rgba(182,192,255,.65); font-size: 12px; line-height:1.45;}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>CBME ‚Äì H∆∞·ªõng d·∫´n ch·∫©n ƒëo√°n h·ªôi ch·ª©ng YHCT (T·ª© ch·∫©n)</h1>
      <p class="subtitle">
        Tab 1: nh·∫≠p h·ªì s∆° + T·ª© ch·∫©n (V·ªçng/VƒÉn/V·∫•n/Thi·∫øt). Tab 2: k·∫øt qu·∫£ suy lu·∫≠n.
        N√∫t ‚ÄúSuy lu·∫≠n‚Äù g·ªçi <span class="mono">POST /infer</span> (mock) ‚Äî sau n√†y thay b·∫±ng RAG/KG/ILP.
      </p>
    </div>

    <nav class="tabs" role="tablist" aria-label="Tabs">
      <button class="tab-btn" id="tab-input" role="tab" aria-selected="true" aria-controls="panel-input">üìù Nh·∫≠p li·ªáu</button>
      <button class="tab-btn" id="tab-output" role="tab" aria-selected="false" aria-controls="panel-output">üß† Ch·∫©n ƒëo√°n</button>
    </nav>
  </header>

  <!-- TAB 1 -->
  <section class="panel active" id="panel-input" role="tabpanel" aria-labelledby="tab-input">
    <div class="grid">
      <!-- KHUNG 1 -->
      <div class="card">
        <h2>Khung 1: Th√¥ng tin ng∆∞·ªùi b·ªánh <span class="badge">B·∫Øt bu·ªôc t·ªëi thi·ªÉu: h·ªç t√™n + tu·ªïi + gi·ªõi</span></h2>

        <div class="form">
          <div class="full">
            <label for="name">H·ªç t√™n</label>
            <input id="name" type="text" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A" />
          </div>

          <div>
            <label for="age">Tu·ªïi</label>
            <input id="age" type="number" min="0" max="130" placeholder="V√≠ d·ª•: 45" />
          </div>

          <div>
            <label for="sex">Gi·ªõi</label>
            <select id="sex">
              <option value="">-- Ch·ªçn --</option>
              <option value="male">Nam</option>
              <option value="female">N·ªØ</option>
              <option value="other">Kh√°c</option>
            </select>
          </div>

          <div>
            <label for="weight">C√¢n n·∫∑ng (kg)</label>
            <input id="weight" type="number" min="0" step="0.1" placeholder="V√≠ d·ª•: 60" />
          </div>

          <div>
            <label for="height">Chi·ªÅu cao (cm)</label>
            <input id="height" type="number" min="0" step="0.1" placeholder="V√≠ d·ª•: 165" />
          </div>

          <div class="full">
            <label for="job">Ngh·ªÅ nghi·ªáp</label>
            <input id="job" type="text" placeholder="V√≠ d·ª•: Gi√°o vi√™n / Nh√¢n vi√™n vƒÉn ph√≤ng / Lao ƒë·ªông..." />
            <p class="hint">G·ª£i √Ω: c√≥ th·ªÉ d√πng ƒë·ªÉ ph√¢n t√≠ch y·∫øu t·ªë nguy c∆° (th√≥i quen, ƒë·ª©ng/ng·ªìi nhi·ªÅu...).</p>
          </div>
        </div>

        <div class="row">
          <button class="btn secondary" id="btnFillDemo" type="button">‚ö° ƒêi·ªÅn d·ªØ li·ªáu m·∫´u</button>
          <button class="btn danger" id="btnClear" type="button">üßπ Xo√° d·ªØ li·ªáu</button>
        </div>
      </div>

      <!-- KHUNG 2 -->
      <div class="card">
        <h2>Khung 2: T·ª© ch·∫©n <span class="badge">CBME input schema</span></h2>

        <div class="subtabs" role="tablist" aria-label="T·ª© ch·∫©n">
          <button class="chip active" type="button" data-block="block-vong">üëÅÔ∏è V·ªçng</button>
          <button class="chip" type="button" data-block="block-van">üëÇ VƒÉn</button>
          <button class="chip" type="button" data-block="block-vanchan">üí¨ V·∫•n</button>
          <button class="chip" type="button" data-block="block-thiet">‚úã Thi·∫øt</button>
        </div>

        <!-- V·ªåNG -->
        <div class="block active" id="block-vong">
          <label for="vongText">V·ªçng ch·∫©n (m√¥ t·∫£ quan s√°t)</label>
          <textarea id="vongText" placeholder="V√≠ d·ª•: s·∫Øc m·∫∑t nh·ª£t, th·∫ßn m·ªát, l∆∞·ª°i nh·∫°t r√™u tr·∫Øng, ng∆∞·ªùi ph√π nh·∫π..."></textarea>
          <p class="hint">Kh√¥ng d√πng ·∫£nh; m√¥ t·∫£ b·∫±ng text ƒë·ªÉ RAG/KG d·ªÖ chu·∫©n ho√°.</p>
        </div>

        <!-- VƒÇN -->
        <div class="block" id="block-van">
          <label for="vanText">VƒÉn ch·∫©n (√¢m thanh, m√πi‚Ä¶)</label>
          <textarea id="vanText" placeholder="V√≠ d·ª•: ti·∫øng n√≥i nh·ªè, h∆°i th·ªü y·∫øu, m√πi mi·ªáng, ho khan/ƒë·ªùm..."></textarea>
          <p class="hint">B·∫°n c√≥ th·ªÉ chu·∫©n ho√° th√†nh t·ª´ kho√° sau n√†y (ontology).</p>
        </div>

        <!-- V·∫§N -->
        <div class="block" id="block-vanchan">
          <div class="vancard">
            <div class="sym-toolbar">
              <div style="flex:1; min-width:240px;">
                <label for="qSymName">Tri·ªáu ch·ª©ng (V·∫•n ch·∫©n)</label>
                <input id="qSymName" type="text" placeholder="V√≠ d·ª•: s·ª£ l·∫°nh / ƒëau l∆∞ng / m·∫•t ng·ªß..." />
              </div>
              <div style="width:140px;">
                <label for="qSymVAS">VAS (1‚Äì10)</label>
                <input id="qSymVAS" type="number" min="1" max="10" step="1" value="5" />
              </div>
              <div style="flex:1; min-width:240px;">
                <label for="qSymTime">Th·ªùi gian xu·∫•t hi·ªán</label>
                <input id="qSymTime" type="text" placeholder="V√≠ d·ª•: 2 tu·∫ßn / 3 th√°ng / t√°i ph√°t 1 nƒÉm..." />
              </div>
              <div class="row" style="margin-top:0;">
                <button class="btn" id="btnAddSym" type="button">‚ûï Th√™m</button>
              </div>
            </div>

            <p class="hint">M·ªói d√≤ng g·ªìm: tri·ªáu ch·ª©ng + VAS + th·ªùi gian. (ƒê√¢y l√† n∆°i b·∫°n t·ª´ng nh·∫ßm; gi·ªù ƒë√£ ƒë√∫ng ·ªü V·∫•n ch·∫©n.)</p>
            <div class="sym-list" id="qSymList"></div>

            <div class="row">
              <button class="btn secondary" id="btnImportFromText" type="button">‚ÜôÔ∏è Nh·∫≠p nhanh t·ª´ text</button>
              <span class="pill">S·ªë tri·ªáu ch·ª©ng: <span class="mono" id="qCount">0</span></span>
            </div>

            <div id="importBox" style="display:none; margin-top:10px;">
              <label for="qImportText">Nh·∫≠p nhanh (m·ªói d√≤ng 1 tri·ªáu ch·ª©ng)</label>
              <textarea id="qImportText" placeholder="- s·ª£ l·∫°nh&#10;- tay ch√¢n l·∫°nh&#10;- m·ªát m·ªèi"></textarea>
              <div class="row">
                <button class="btn" id="btnApplyImport" type="button">‚úÖ √Åp d·ª•ng</button>
                <button class="btn secondary" id="btnCancelImport" type="button">‚úñ Hu·ª∑</button>
              </div>
              <p class="hint">M·∫∑c ƒë·ªãnh VAS=5, th·ªùi gian=‚Äúkh√¥ng r√µ‚Äù (b·∫°n c√≥ th·ªÉ ch·ªânh t·ª´ng d√≤ng sau).</p>
            </div>
          </div>
        </div>

        <!-- THI·∫æT -->
        <div class="block" id="block-thiet">
          <label for="thietText">Thi·∫øt ch·∫©n (m·∫°ch, ·∫•n ƒëau, s·ªù l·∫°nh/n√≥ng‚Ä¶)</label>
          <textarea id="thietText" placeholder="V√≠ d·ª•: m·∫°ch tr·∫ßm tr√¨, ·∫•n ƒëau v√πng th·∫Øt l∆∞ng, s·ªù chi l·∫°nh..."></textarea>
          <p class="hint">C√≥ th·ªÉ chu·∫©n ho√° m·∫°ch t∆∞·ª£ng/·∫•n ch·∫©n th√†nh tr∆∞·ªùng ri√™ng sau n√†y.</p>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn" id="btnInfer" type="button">üß† Suy lu·∫≠n &amp; xem ch·∫©n ƒëo√°n</button>
          <span class="pill">BMI: <span class="mono" id="bmiValue">‚Äî</span></span>
          <span class="pill">Tr·∫°ng th√°i: <span class="mono" id="statusValue">Ch∆∞a suy lu·∫≠n</span></span>
        </div>

        <p class="hint">
          Hi·ªán g·ªçi <span class="mono">POST /infer</span> (mock). N·∫øu API l·ªói/kh√¥ng t·ªìn t·∫°i, t·ª± fallback sang demo rule-based trong browser.
        </p>
      </div>
    </div>

    <footer>
      <b>L∆∞u √Ω:</b> ƒê√¢y l√† c√¥ng c·ª• h·ªó tr·ª£ nghi√™n c·ª©u/hu·∫•n luy·ªán. Kh√¥ng thay th·∫ø ch·∫©n ƒëo√°n y khoa.
    </footer>
  </section>

  <!-- TAB 2 -->
  <section class="panel" id="panel-output" role="tabpanel" aria-labelledby="tab-output">
    <div class="card">
      <div class="result-top">
        <div>
          <h2 style="margin:0;">K·∫øt qu·∫£ ch·∫©n ƒëo√°n (sau suy lu·∫≠n)</h2>
          <p class="hint" style="margin-top:6px;">Hi·ªÉn th·ªã top h·ªôi ch·ª©ng + gi·∫£i th√≠ch + c√¢u h·ªèi b·ªï sung.</p>
        </div>
        <div class="pill">H·ªì s∆°: <span class="mono" id="profileSummary">‚Äî</span></div>
      </div>

      <div class="diag" id="bestDiag">
        <h3>Ch∆∞a c√≥ k·∫øt qu·∫£</h3>
        <p>H√£y nh·∫≠p d·ªØ li·ªáu ·ªü Tab 1 v√† b·∫•m ‚ÄúSuy lu·∫≠n‚Äù.</p>
      </div>

      <ul class="list" id="rankList"></ul>

      <div class="warn">
        <b>C·∫£nh b√°o an to√†n:</b> N·∫øu c√≥ d·∫•u hi·ªáu c·∫•p c·ª©u (ƒëau ng·ª±c, kh√≥ th·ªü, y·∫øu li·ªát, l√∫ l·∫´n, s·ªët cao k√©o d√†i...), c·∫ßn kh√°m/c·∫•p c·ª©u ngay.
      </div>

      <footer>
        G·ª£i √Ω n√¢ng c·∫•p: <span class="mono">/infer</span> ‚Üí RAG (Supabase) + KG (symptom‚Üísyndrome) + constraint (incompatibility) + explanation by LLM.
      </footer>
    </div>
  </section>
</div>

<script>
  // ---------------- Tabs (main) ----------------
  const tabInput = document.getElementById('tab-input');
  const tabOutput = document.getElementById('tab-output');
  const panelInput = document.getElementById('panel-input');
  const panelOutput = document.getElementById('panel-output');

  function setTab(which){
    const isInput = which === 'input';
    tabInput.setAttribute('aria-selected', String(isInput));
    tabOutput.setAttribute('aria-selected', String(!isInput));
    panelInput.classList.toggle('active', isInput);
    panelOutput.classList.toggle('active', !isInput);
  }
  tabInput.addEventListener('click', () => setTab('input'));
  tabOutput.addEventListener('click', () => setTab('output'));

  // ---------------- Subtabs (T·ª© ch·∫©n) ----------------
  const chips = Array.from(document.querySelectorAll('.chip'));
  const blocks = {
    "block-vong": document.getElementById("block-vong"),
    "block-van": document.getElementById("block-van"),
    "block-vanchan": document.getElementById("block-vanchan"),
    "block-thiet": document.getElementById("block-thiet"),
  };
  function setBlock(id){
    for(const c of chips){
      c.classList.toggle("active", c.dataset.block === id);
    }
    for(const k of Object.keys(blocks)){
      blocks[k].classList.toggle("active", k === id);
    }
  }
  chips.forEach(c => c.addEventListener("click", () => setBlock(c.dataset.block)));

  // ---------------- Fields ----------------
  const elName = document.getElementById('name');
  const elAge = document.getElementById('age');
  const elSex = document.getElementById('sex');
  const elWeight = document.getElementById('weight');
  const elHeight = document.getElementById('height');
  const elJob = document.getElementById('job');

  const elVong = document.getElementById('vongText');
  const elVan = document.getElementById('vanText');
  const elThiet = document.getElementById('thietText');

  const bmiValue = document.getElementById('bmiValue');
  const statusValue = document.getElementById('statusValue');

  const profileSummary = document.getElementById('profileSummary');
  const bestDiag = document.getElementById('bestDiag');
  const rankList = document.getElementById('rankList');

  function computeBMI(){
    const w = parseFloat(elWeight.value);
    const hCm = parseFloat(elHeight.value);
    if(!isFinite(w) || !isFinite(hCm) || w<=0 || hCm<=0) return null;
    const h = hCm / 100;
    const bmi = w / (h*h);
    return Math.round(bmi * 10) / 10;
  }
  function updateBMIPill(){
    const bmi = computeBMI();
    bmiValue.textContent = (bmi === null) ? '‚Äî' : String(bmi);
  }
  elWeight.addEventListener('input', updateBMIPill);
  elHeight.addEventListener('input', updateBMIPill);

  // ---------------- V·∫•n ch·∫©n list (VAS + time) ----------------
  const qSymName = document.getElementById("qSymName");
  const qSymVAS = document.getElementById("qSymVAS");
  const qSymTime = document.getElementById("qSymTime");
  const qSymList = document.getElementById("qSymList");
  const qCount = document.getElementById("qCount");

  const btnAddSym = document.getElementById("btnAddSym");
  const btnImportFromText = document.getElementById("btnImportFromText");
  const importBox = document.getElementById("importBox");
  const qImportText = document.getElementById("qImportText");
  const btnApplyImport = document.getElementById("btnApplyImport");
  const btnCancelImport = document.getElementById("btnCancelImport");

  /** @type {{id:string, name:string, vas:number, onset:string}[]} */
  let qSymptoms = [];

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function clamp(n, a, b){
    return Math.max(a, Math.min(b, n));
  }

  function renderQList(){
    qSymList.innerHTML = "";
    qCount.textContent = String(qSymptoms.length);

    if(qSymptoms.length === 0){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "Ch∆∞a c√≥ tri·ªáu ch·ª©ng. Th√™m ·ªü tr√™n ho·∫∑c nh·∫≠p nhanh t·ª´ text.";
      qSymList.appendChild(empty);
      return;
    }

    for(const s of qSymptoms){
      const wrap = document.createElement("div");
      wrap.className = "sym-item";
      wrap.dataset.id = s.id;

      wrap.innerHTML = `
        <div class="sym-head">
          <p class="sym-name">${escapeHtml(s.name)}</p>
          <div class="sym-actions">
            <button class="icon-btn" type="button" data-act="dup">‚éò</button>
            <button class="icon-btn" type="button" data-act="del">üóë</button>
          </div>
        </div>
        <div class="sym-grid">
          <div>
            <label>Tri·ªáu ch·ª©ng</label>
            <input data-field="name" value="${escapeHtmlAttr(s.name)}" />
          </div>
          <div>
            <label>VAS (1‚Äì10)</label>
            <input data-field="vas" type="number" min="1" max="10" step="1" value="${s.vas}" />
          </div>
          <div>
            <label>Th·ªùi gian</label>
            <input data-field="onset" value="${escapeHtmlAttr(s.onset)}" placeholder="V√≠ d·ª•: 2 tu·∫ßn / 3 th√°ng..." />
          </div>
        </div>
      `;

      wrap.addEventListener("input", (e) => {
        const t = e.target;
        if(!(t instanceof HTMLInputElement)) return;
        const id = wrap.dataset.id;
        const item = qSymptoms.find(x => x.id === id);
        if(!item) return;

        const field = t.getAttribute("data-field");
        if(field === "name"){
          item.name = t.value.trim();
        }else if(field === "vas"){
          const v = clamp(parseInt(t.value || "5", 10), 1, 10);
          item.vas = v;
          t.value = String(v);
        }else if(field === "onset"){
          item.onset = t.value.trim();
        }
      });

      wrap.addEventListener("click", (e) => {
        const btn = e.target;
        if(!(btn instanceof HTMLButtonElement)) return;
        const act = btn.getAttribute("data-act");
        if(!act) return;
        const id = wrap.dataset.id;
        if(act === "del"){
          qSymptoms = qSymptoms.filter(x => x.id !== id);
          renderQList();
        }else if(act === "dup"){
          const base = qSymptoms.find(x => x.id === id);
          if(!base) return;
          qSymptoms.unshift({ ...base, id: uid() });
          renderQList();
        }
      });

      qSymList.appendChild(wrap);
    }
  }

  function addSym(name, vas, onset){
    const n = (name || "").trim();
    if(!n) return false;
    const v = clamp(parseInt(String(vas || 5), 10), 1, 10);
    const o = (onset || "").trim() || "kh√¥ng r√µ";
    qSymptoms.unshift({ id: uid(), name: n, vas: v, onset: o });
    return true;
  }

  btnAddSym.addEventListener("click", () => {
    const ok = addSym(qSymName.value, qSymVAS.value, qSymTime.value);
    if(!ok){
      alert("Nh·∫≠p t√™n tri·ªáu ch·ª©ng tr∆∞·ªõc khi th√™m.");
      return;
    }
    qSymName.value = "";
    qSymVAS.value = "5";
    qSymTime.value = "";
    renderQList();
  });

  btnImportFromText.addEventListener("click", () => {
    importBox.style.display = (importBox.style.display === "none") ? "block" : "none";
  });

  btnCancelImport.addEventListener("click", () => {
    importBox.style.display = "none";
  });

  btnApplyImport.addEventListener("click", () => {
    const lines = (qImportText.value || "")
      .split(/\n+/)
      .map(x => x.replace(/[‚Ä¢\-\u2022]/g, " ").trim())
      .filter(Boolean);

    if(lines.length === 0){
      alert("Ch∆∞a c√≥ d√≤ng n√†o.");
      return;
    }
    for(const ln of lines){
      addSym(ln, 5, "kh√¥ng r√µ");
    }
    qImportText.value = "";
    importBox.style.display = "none";
    renderQList();
  });

  // init qlist
  renderQList();

  // ---------------- Profile & payload ----------------
  function formatProfile(){
    const name = (elName.value || "").trim() || "‚Äî";
    const age = (elAge.value || "").trim() ? `${elAge.value.trim()}t` : "‚Äî";
    const sex = elSex.value;
    const sexLabel = sex === "male" ? "Nam" : sex === "female" ? "N·ªØ" : sex === "other" ? "Kh√°c" : "‚Äî";
    const job = (elJob.value || "").trim() || "‚Äî";
    const bmi = computeBMI();
    const bmiText = (bmi === null) ? "BMI ‚Äî" : `BMI ${bmi}`;
    return `${name} ¬∑ ${age} ¬∑ ${sexLabel} ¬∑ ${bmiText} ¬∑ ${job}`;
  }

  function buildPayload(){
    const patient = {
      name: (elName.value || "").trim(),
      age: Number(elAge.value || 0) || null,
      sex: elSex.value || null,
      weight_kg: Number(elWeight.value || 0) || null,
      height_cm: Number(elHeight.value || 0) || null,
      job: (elJob.value || "").trim() || null,
      bmi: computeBMI()
    };
    const fourDx = {
      vong_text: (elVong.value || "").trim(),
      van_text: (elVan.value || "").trim(),
      van_chung: qSymptoms.map(s => ({
        symptom: s.name,
        vas: s.vas,
        onset: s.onset
      })),
      thiet_text: (elThiet.value || "").trim()
    };
    return { patient, fourDx, meta: { schema: "cbme-yhct-four-dx:v1" } };
  }

  function validateMinimum(){
    const name = (elName.value || "").trim();
    const age = (elAge.value || "").trim();
    const sex = elSex.value;
    if(!name || !age || !sex){
      alert("B·∫°n vui l√≤ng nh·∫≠p t·ªëi thi·ªÉu: H·ªç t√™n + Tu·ªïi + Gi·ªõi.");
      return false;
    }
    // require some evidence in either: v·ªçng/vƒÉn/v·∫•n/thi·∫øt
    const anyText = (elVong.value || "").trim() || (elVan.value || "").trim() || (elThiet.value || "").trim();
    if(qSymptoms.length === 0 && !anyText){
      alert("B·∫°n vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 th√¥ng tin T·ª© ch·∫©n (V·ªçng/VƒÉn/V·∫•n/Thi·∫øt).");
      return false;
    }
    return true;
  }

  // ---------------- Output render ----------------
  function renderOutputFromApi(data){
    // Expected shape:
    // { best: { label, score, evidence[], questions[] }, ranked: [{label, score, evidence[]}], warnings[] }
    profileSummary.textContent = formatProfile();

    const best = data?.best;
    if(!best){
      bestDiag.innerHTML = `<h3>Ch∆∞a c√≥ k·∫øt qu·∫£</h3><p>API tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá.</p>`;
      rankList.innerHTML = "";
      return;
    }

    const ev = Array.isArray(best.evidence) ? best.evidence : [];
    const qs = Array.isArray(best.questions) ? best.questions : [];
    const warns = Array.isArray(data.warnings) ? data.warnings : [];

    bestDiag.innerHTML = `
      <h3>H·ªôi ch·ª©ng g·ª£i √Ω: ${escapeHtml(best.label || "‚Äî")}</h3>
      <p><b>ƒêi·ªÉm ph√π h·ª£p:</b> ${escapeHtml(String(best.score ?? "‚Äî"))}</p>
      <p style="margin-top:8px;color:var(--muted);font-size:12px;line-height:1.45;">
        <b>B·∫±ng ch·ª©ng</b> (tr√≠ch xu·∫•t t·ª´ T·ª© ch·∫©n):
      </p>
      <ul style="margin:8px 0 0; padding-left: 18px; color: var(--text); font-size: 13px; line-height:1.5;">
        ${ev.length ? ev.map(x => `<li>${escapeHtml(x)}</li>`).join("") : "<li>‚Äî</li>"}
      </ul>
      <p style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.45;">
        <b>C√¢u h·ªèi b·ªï sung</b>:
      </p>
      <ul style="margin:8px 0 0; padding-left: 18px; color: var(--text); font-size: 13px; line-height:1.5;">
        ${qs.length ? qs.map(x => `<li>${escapeHtml(x)}</li>`).join("") : "<li>‚Äî</li>"}
      </ul>
      ${warns.length ? `
        <div class="warn" style="margin-top:12px;">
          <b>G·ª£i √Ω ki·ªÉm tra ƒë·ªëi ch·ª©ng/ki√™m ch·ª©ng:</b>
          <div style="margin-top:6px;color:var(--muted);font-size:12px;line-height:1.45;">
            ${warns.map(m => `‚Ä¢ ${escapeHtml(m)}`).join("<br/>")}
          </div>
        </div>` : ""
      }
    `;

    const ranked = Array.isArray(data.ranked) ? data.ranked : [];
    rankList.innerHTML = "";
    for(const r of ranked.slice(0, 6)){
      const li = document.createElement("li");
      li.className = "item";
      const rEv = Array.isArray(r.evidence) ? r.evidence : [];
      li.innerHTML = `
        <p class="k"><span>${escapeHtml(r.label || "‚Äî")}</span><span class="score">score: ${escapeHtml(String(r.score ?? "‚Äî"))}</span></p>
        <p class="v">B·∫±ng ch·ª©ng: ${rEv.length ? rEv.map(x => `<span class="mono">${escapeHtml(x)}</span>`).join(", ") : "‚Äî"}</p>
      `;
      rankList.appendChild(li);
    }
  }

  // ---------------- Browser fallback demo (rule-based) ----------------
  // (Gi·ªØ tinh th·∫ßn code c≈© c·ªßa b·∫°n ƒë·ªÉ kh√¥ng b·ªã ‚Äúƒë·ª©t‚Äù n·∫øu API ch∆∞a c√≥)
  const KNOWLEDGE = [
    {
      label: "Th·∫≠n d∆∞∆°ng h∆∞ / D∆∞∆°ng h∆∞ (g·ª£i √Ω)",
      keywords: ["s·ª£ l·∫°nh","l·∫°nh","tay ch√¢n l·∫°nh","m·ªát m·ªèi","ti·ªÉu trong","ti·ªÉu nhi·ªÅu","ph√π","ƒëau l∆∞ng","l∆∞·ª°i nh·∫°t","r√™u tr·∫Øng"],
      questions: [
        "B·∫°n c√≥ s·ª£ l·∫°nh r√µ, th√≠ch ·∫•m, ∆∞a ch∆∞·ªùm ·∫•m kh√¥ng?",
        "Ti·ªÉu trong nhi·ªÅu/l√¢u? c√≥ ph√π nh·∫π bu·ªïi s√°ng kh√¥ng?",
        "L∆∞ng g·ªëi m·ªèi l·∫°nh, sinh l·ª±c gi·∫£m?"
      ]
    },
    {
      label: "Th·∫≠n √¢m h∆∞ / √Çm h∆∞ (g·ª£i √Ω)",
      keywords: ["n√≥ng trong","tri·ªÅu nhi·ªát","ra m·ªì h√¥i tr·ªôm","kh√¥ mi·ªáng","kh√°t","m·∫•t ng·ªß","b·ª©t r·ª©t","l∆∞·ª°i ƒë·ªè","√≠t r√™u","t√°o b√≥n"],
      questions: [
        "C√≥ n√≥ng v·ªÅ chi·ªÅu/ƒë√™m, ra m·ªì h√¥i tr·ªôm kh√¥ng?",
        "Kh√¥ h·ªçng, kh√°t, l∆∞·ª°i ƒë·ªè √≠t r√™u?",
        "M·∫•t ng·ªß, b·ª©t r·ª©t, t√°o b√≥n?"
      ]
    },
    {
      label: "T·ª≥ kh√≠ h∆∞ (g·ª£i √Ω)",
      keywords: ["ƒÉn k√©m","ƒë·∫ßy b·ª•ng","ch∆∞·ªõng b·ª•ng","m·ªát sau ƒÉn","ƒë·∫°i ti·ªán l·ªèng","ti√™u ch·∫£y","l∆∞·ª°i nh·∫°t","r√™u tr·∫Øng"],
      questions: [
        "ƒÇn k√©m, ƒë·∫ßy b·ª•ng, m·ªát sau ƒÉn?",
        "ƒê·∫°i ti·ªán l·ªèng/ti√™u ch·∫£y k√©o d√†i?",
        "L∆∞·ª°i nh·∫°t r√™u tr·∫Øng, s·∫Øc m·∫∑t v√†ng?"
      ]
    },
    {
      label: "Can kh√≠ u·∫•t (g·ª£i √Ω)",
      keywords: ["cƒÉng t·ª©c ng·ª±c","s∆∞·ªùn ƒëau t·ª©c","th·ªü d√†i","d·ªÖ c√°u","stress","u·∫•t ·ª©c","ƒë·∫ßy t·ª©c","ƒëau ƒë·∫ßu"],
      questions: [
        "C√≥ hay th·ªü d√†i, t·ª©c ng·ª±c/s∆∞·ªùn, n·∫∑ng khi stress?",
        "D·ªÖ c√°u g·∫Øt, u·∫•t ·ª©c, ng·ªß k√©m?",
        "N·ªØ: kinh nguy·ªát th·∫•t th∆∞·ªùng/ƒëau b·ª•ng kinh?"
      ]
    }
  ];

  function normalizeText(t){
    return String(t || "")
      .toLowerCase()
      .replace(/[‚Ä¢\-\u2022]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function buildEvidenceText(){
    // Combine 4 parts into one searchable text (for fallback)
    const vong = normalizeText(elVong.value);
    const van = normalizeText(elVan.value);
    const thiet = normalizeText(elThiet.value);
    const vanChan = qSymptoms.map(s => normalizeText(s.name)).join(" ");
    return [vong, van, vanChan, thiet].filter(Boolean).join(" ");
  }

  function inferFallback(){
    const full = buildEvidenceText();
    const ranked = KNOWLEDGE.map(k => {
      let score = 0;
      const hits = [];
      for(const kw of k.keywords){
        if(full.includes(kw)){
          // Add weight from VAS if symptom was in V·∫•n ch·∫©n
          const fromQ = qSymptoms.find(s => normalizeText(s.name).includes(kw));
          score += fromQ ? Math.max(1, Math.round(fromQ.vas / 3)) : 1;
          hits.push(kw);
        }
      }
      return { label: k.label, score, evidence: hits.slice(0, 10), questions: k.questions };
    }).sort((a,b)=>b.score-a.score);

    const best = ranked[0];
    return {
      best: {
        label: best?.label || "Ch∆∞a ƒë·ªß d·ªØ li·ªáu",
        score: best?.score ?? 0,
        evidence: best?.evidence?.length ? best.evidence.map(x=>`Kh·ªõp: ${x}`) : ["‚Äî"],
        questions: best?.questions || []
      },
      ranked: ranked.slice(0, 5).map(r => ({ label: r.label, score: r.score, evidence: r.evidence })),
      warnings: []
    };
  }

  // ---------------- API call (/infer) ----------------
  async function callInferApi(payload){
    const res = await fetch("/infer", {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status} ${res.statusText} ${t}`.trim());
    }
    return await res.json();
  }

  // ---------------- Buttons ----------------
  const btnInfer = document.getElementById('btnInfer');
  const btnClear = document.getElementById('btnClear');
  const btnFillDemo = document.getElementById('btnFillDemo');

  btnInfer.addEventListener('click', async () => {
    if(!validateMinimum()){
      statusValue.textContent = "Thi·∫øu d·ªØ li·ªáu t·ªëi thi·ªÉu";
      return;
    }
    updateBMIPill();
    statusValue.textContent = "ƒêang suy lu·∫≠n...";

    const payload = buildPayload();

    try{
      // Try API first
      const data = await callInferApi(payload);
      renderOutputFromApi(data);
      statusValue.textContent = "ƒê√£ suy lu·∫≠n (API)";
      setTab('output');
    }catch(err){
      // Fallback to browser demo
      console.warn("Infer API failed, fallback:", err);
      const data = inferFallback();
      renderOutputFromApi(data);
      statusValue.textContent = "ƒê√£ suy lu·∫≠n (fallback)";
      setTab('output');
      alert("API /infer ch∆∞a ch·∫°y ho·∫∑c l·ªói. H·ªá th·ªëng d√πng fallback demo trong tr√¨nh duy·ªát.");
    }
  });

  btnClear.addEventListener('click', () => {
    elName.value = "";
    elAge.value = "";
    elSex.value = "";
    elWeight.value = "";
    elHeight.value = "";
    elJob.value = "";
    elVong.value = "";
    elVan.value = "";
    elThiet.value = "";

    qSymptoms = [];
    renderQList();

    updateBMIPill();
    statusValue.textContent = "Ch∆∞a suy lu·∫≠n";
    profileSummary.textContent = "‚Äî";
    bestDiag.innerHTML = `<h3>Ch∆∞a c√≥ k·∫øt qu·∫£</h3><p>H√£y nh·∫≠p d·ªØ li·ªáu ·ªü Tab 1 v√† b·∫•m ‚ÄúSuy lu·∫≠n‚Äù.</p>`;
    rankList.innerHTML = "";
    setTab('input');
    setBlock("block-vong");
  });

  btnFillDemo.addEventListener('click', () => {
    elName.value = "Nguy·ªÖn VƒÉn A";
    elAge.value = "52";
    elSex.value = "male";
    elWeight.value = "68";
    elHeight.value = "170";
    elJob.value = "Nh√¢n vi√™n vƒÉn ph√≤ng";

    elVong.value = "S·∫Øc m·∫∑t nh·ª£t, l∆∞·ª°i nh·∫°t r√™u tr·∫Øng, th·∫ßn m·ªát.";
    elVan.value = "Ti·∫øng n√≥i nh·ªè, h∆°i th·ªü y·∫øu.";
    elThiet.value = "M·∫°ch tr·∫ßm tr√¨, s·ªù chi l·∫°nh.";

    qSymptoms = [];
    addSym("s·ª£ l·∫°nh", 7, "3 th√°ng");
    addSym("tay ch√¢n l·∫°nh", 6, "3 th√°ng");
    addSym("m·ªát m·ªèi", 6, "2 th√°ng");
    addSym("ti·ªÉu trong nhi·ªÅu", 5, "1 th√°ng");
    addSym("ƒëau l∆∞ng m·ªèi g·ªëi", 6, "6 th√°ng");
    renderQList();

    updateBMIPill();
    statusValue.textContent = "ƒê√£ ƒëi·ªÅn d·ªØ li·ªáu m·∫´u";
    setBlock("block-vanchan");
  });

  // ---------------- Small helpers ----------------
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeHtmlAttr(str){
    return escapeHtml(str).replaceAll('"','&quot;');
  }

  // Init
  updateBMIPill();
</script>
</body>
</html>
